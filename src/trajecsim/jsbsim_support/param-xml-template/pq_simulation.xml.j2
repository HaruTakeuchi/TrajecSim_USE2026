<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet type="text/xsl" href="http://jsbsim.sf.net/JSBSimScript.xsl"?>
<runscript xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="http://jsbsim.sf.net/JSBSimScript.xsd"
    name="Rocket flight.">


  <use aircraft="PQ_ROCKET" initialize="liftoff"/>

  <run start="0" end="{{ flight_duration }}" dt="{{ time_step }}">



    <!-- start off on the ground -->
    <property value="1"> forces/hold-down </property>

    <property value="0"> simulation/notify-time-trigger </property>

    <property value="100000000"> simulation/parachute_deploy_time </property>

    <property value="0"> simulation/wind_direction_parachute_deploy </property>

    <property value="1"> simulation/launch_cleared </property>



    <!-- Ignite -->
    <event name="Ignition">
        <condition>simulation/sim-time-sec  ge  {{ time_step * 100}}</condition>
    </event>

    <!-- Liftoff -->
    <event name="liftoff">
      <condition>simulation/sim-time-sec  ge  {{ liftoff_time }}</condition>
      <set name="forces/hold-down" value="0"/>
      <set name="atmosphere/turb-type" value="0"/>
    </event>

    <!-- Burnout -->
    <event name="Motor Burnout">
      <condition>propulsion/tank[0]/contents-lbs lt 0.1</condition>
    </event>

    <!-- Zero Vertical Velocity -->
    <event name="Apogee">
      <condition>velocities/v-down-fps gt 1</condition>
      <set name="simulation/wind_direction_parachute_deploy" value="{{ wind_direction_parachute_deploy }}"/>
      <set name="simulation/parachute_deploy_time" >
        <function>
          <sum>
            <property>simulation/sim-time-sec</property>
            <value>{{ parachute_deploy_delay }}</value>
          </sum>
        </function>
      </set>
      {% if apogee_mode == 1 %}
      <set name="simulation/terminate" value="1"/>
      {% endif %}
    </event>

    <event name="Landed">
      <condition>
position/h-agl-ft lt 0.01
</condition>
      <set name="simulation/terminate" value="1"/>
    </event>

    <event name="Winds aloft" continuous="true">
      <condition>position/h-sl-meters gt {{ launcher_height }}</condition>
      <set name="atmosphere/psiw-rad">
      <function>
      <sum>
      <property>simulation/wind_direction_parachute_deploy</property>
      <table>
      <independentVar lookup="row"> position/h-sl-meters </independentVar>
      <tableData>
        {% for wind in winds_table|sort(attribute='0')|unique(attribute='0') -%}
        {{ wind[0] }} {{ wind[2]*0.0174533}}
        {% endfor %}
      </tableData>
      </table>
      </sum>
      </function>
      </set>
      <set name="atmosphere/wind-mag-fps">
      <function>
      <table>
      <independentVar lookup="row"> position/h-sl-meters </independentVar>
      <tableData>
        {% for wind in winds_table|sort(attribute='0')|unique(attribute='0') -%}
        {{ wind[0]  }} {{ wind[1] *3.280840}}
        {% endfor %}
      </tableData>
      </table>
      </function>
      </set>
      <set name="simulation/launch_cleared" value="1"/>
    </event>


  </run>

  <output name="pq_rocket_output_raw.csv" type="CSV" rate="100" file="unitconversions.xml">
    <property caption="Latitude">position/lat-gc-deg</property>
    <property caption="Longitude">position/long-gc-deg</property>
    <property apply="convert-ft-To-m" caption="Altitude">position/h-agl-ft</property>
    <property apply="convert-rad-To-deg" caption="Angle of Attack">aero/alpha-rad</property>
    <property apply="convert-rad-To-deg" caption="Angle of Sideslip">aero/beta-rad</property>
    <property apply="convert-ft_sec2-To-m_sec2" caption="X-Acceleration">accelerations/udot-ft_sec2</property>
    <property apply="convert-ft_sec2-To-m_sec2" caption="Y-Acceleration">accelerations/vdot-ft_sec2</property>
    <property apply="convert-ft_sec2-To-m_sec2" caption="Z-Acceleration">accelerations/wdot-ft_sec2</property>

    <property apply="convert-lbs-To-N" caption="Thrust">external_reactions/thrust/magnitude</property>
    <property apply="convert-fps-To-ms" caption="True Velocity">velocities/vtrue-fps</property>
    <property apply="convert-fps-To-m_s" caption="Ground Velocity">velocities/vg-fps</property>
    <property apply="convert-rad-To-deg" caption="Pitch">attitude/theta-rad</property>
    <property apply="convert-rad-To-deg" caption="Roll">attitude/phi-rad</property>
    <property apply="convert-rad-To-deg" caption="Yaw">attitude/psi-rad</property>
    <property apply="convert-psf-To-Pa" caption="Dynamic Pressure">aero/qbar-psf</property>
    <property apply="convert-ft-To-m" caption="cp">metrics/aero-rp-x-in</property>
    <property caption="parachute_deploy_gain">fcs/parachute_reef_pos_norm</property>
    <property apply="convert-fps-To-m_s" caption="Wind Speed">atmosphere/wind-mag-fps</property>
    <property caption="Mach">velocities/mach</property>
    <!-- Debug  -->
    <property caption="omega_x">velocities/p-rad_sec</property>
    <property caption="omega_y">velocities/q-rad_sec</property>
    <property caption="omega_z">velocities/r-rad_sec</property>
    <property caption="Cmq">aero/coefficient/Cmq</property>
  </output>
</runscript>